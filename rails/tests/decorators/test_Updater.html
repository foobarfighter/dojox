<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<title></title>
	<script type="text/javascript" src="../../../../dojo/dojo.js"
	    djConfig="isDebug: true, parseOnLoad: true"></script>
	<script type="text/javascript">
        dojo.require("doh.runner");
        dojo.require("dojox.rails.tests.helpers");

        dojo.require("dojox.rails.decorators.Updater");

        var fakeRequest = { responseText: "fake text!" };
        var faceIoArgs = {};
        var resetSandbox = function(){
            dojo.byId("sandbox").innerHTML = dojo.byId("generator").innerHTML;
        }

        var drd = dojox.rails.decorators;
		doh.register("dojox.rails.tests.decorators.Updater", [
            {
				name: "Test Request params parsing",
				runTest: function(t) {
                }
			},
            {
                name: "Test mappings",
                runTest: function(t) {
                    var mappedArgs;
                    mappedArgs = drd._UpdaterArgMap.map({eval: "true", position: "top"});
                    t.is("first", mappedArgs.place);
                    t.t(mappedArgs.evalScripts);

                    mappedArgs = drd._UpdaterArgMap.map({eval: true, position: "bottom"});
                    t.is("last", mappedArgs.place);
                    t.t(mappedArgs.evalScripts);

                    mappedArgs = drd._UpdaterArgMap.map({eval: "false", position: "before"});
                    t.is("before", mappedArgs.place);
                    t.f(mappedArgs.evalScripts);

                    mappedArgs = drd._UpdaterArgMap.map({eval: null, position: "after"});
                    t.is("after", mappedArgs.place);
                    t.f(mappedArgs.evalScripts);

                    mappedArgs = drd._UpdaterArgMap.map({
                        "update-success": ".success",
                        "update-failure": ".failure",
                        "update-complete": ".complete"
                    });
                    t.is(".success", mappedArgs.successQuery);
                    t.is(".failure", mappedArgs.failureQuery);
                    t.is(".complete", mappedArgs.completeQuery);
                }
            },
            {
				name: "Test Updater args parsing",
				runTest: function(t) {
                    var updater = new drd.Updater("test_first");
                    var args = updater._updaterArgs;
                    t.is("first", args.place);
                    t.t(args.evalScripts);
                    t.is("#sandbox .success_container div.out", args.successQuery);
                    t.is("#sandbox .failure_container div.out", args.failureQuery);
                    t.is("#sandbox .complete_container div.out", args.completeQuery);
                }
			},
            {
                name: "Test Updater handlers are connected",
                runTest: function(t) {
                    var updater = new drd.Updater("test_first");

                    t.mock(updater, "_handleSuccess");
                    updater.onSuccess(fakeRequest, faceIoArgs);
                    t.assertMock(updater._handleSuccess);

                    t.mock(updater, "_handleFailure");
                    updater.onFailure(fakeRequest, faceIoArgs);
                    t.assertMock(updater._handleFailure);

//                    t.mock(updater, "_handleComplete");
//                    updater.onComplete(fakeRequest, faceIoArgs);
//                    t.assertMock(updater._handleComplete);
                }
            },
            {
                name: "EvalScripts integration test",
                setUp: function() {
                    dojo.global.testEvalScripts = function() {};
                },
                tearDown: function() {
                    delete dojo.global["testEvalScripts"];
                },
                runTest: function(t) {
                    var updater = new drd.Updater("test_first");

                    t.t(updater._updaterArgs.evalScripts);
                    t.mock(dojo.global, "testEvalScripts");

                    updater.exec("../fixtures/test_ajax.html");
                    var d = new doh.Deferred();
                    setTimeout(function() { d.callback(dojo.global.testEvalScripts.__mockCalled == 1); }, 200);

                    return d;
                }
            },
            {
                name: "NO EvalScripts integration test",
                setUp: function() {
                    dojo.global.testEvalScripts = function() {};
                },
                tearDown: function() {
                    delete dojo.global["testEvalScripts"];
                },
                runTest: function(t) {
                    var updater = new drd.Updater("test_first");

                    updater._updaterArgs.evalScripts = false;
                    t.f(updater._updaterArgs.evalScripts);
                    t.mock(dojo.global, "testEvalScripts");

                    updater.exec("../fixtures/test_ajax.html");
                    var d = new doh.Deferred();
                    setTimeout(function() { d.callback(!dojo.global.testEvalScripts.__mockCalled); }, 200);

                    return d;
                }
            }
		]);

        dojo.addOnLoad(function() {
            doh.run();
        });
	</script>
</head>
<body>

<script type="javascript/json" data-js-type="updater" id="test_first"
    data-position="top"
    data-update-success="#sandbox .success_container div.out"
    data-update-failure="#sandbox .failure_container div.out"
    data-update-complete="#sandbox .complete_container div.out"
    data-eval="true">
</script>

<script type="javascript/json" data-js-type="updater" id="test_last"
    data-position="bottom"
    data-update-success="#sandbox .success_container div.out"
    data-update-failure="#sandbox .failure_container div.out"
    data-update-complete="#sandbox .complete_container div.out">
</script>

<script type="javascript/json" data-js-type="updater" id="test_before"
    data-position="before"
    data-update-success="#sandbox .success_container div.out"
    data-update-failure="#sandbox .failure_container div.out"
    data-update-complete="#sandbox .complete_container div.out">
</script>

<script type="javascript/json" data-js-type="updater" id="test_after"
    data-position="after"
    data-update-success="#sandbox .success_container div.out"
    data-update-failure="#sandbox .failure_container div.out"
    data-update-complete="#sandbox .complete_container div.out">
</script>


<!-- Test output nodes -->
<div id="generator">
    <blockquote class="success_container">
        <span>First span</span>
        <div class="out"></div>
        <span>Last span</span>
    </blockquote>
    <blockquote class="failure_container">
        <span>First span</span>
        <div class="out"></div>
        <span>Last span</span>
    </blockquote>
    <blockquote class="complete_container">
        <span>First span</span>
        <div class="out"></div>
        <span>Last span</span>
    </blockquote>
</div>

<!-- Setup for the test will go here.  Refreshed between tests. -->
<div id="sandbox">
</div>


</body>
</html>