<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<title></title>
	<script type="text/javascript" src="../../../../dojo/dojo.js"
	    djConfig="isDebug: true"></script>
	<script type="text/javascript">
		dojo.require("doh.runner");
        dojo.require("dojox.rails.tests.helpers");

		dojo.require("dojox.rails.decorators.Request");

        var drd = dojox.rails.decorators;
        var fakeRequest = { responseText: "fake text!" };
        var faceIoArgs = {};

        doh.register("dojox.rails.tests.decorators.Request", [
            {
                name: "Callback parsing",
                runTest: function(t) {
                    var request = new drd.Request("test_successful_callback_parse");

                    var assertCallbackConnection = function(cbName){
                        var cbMapping = "on" + dojox.rails.camelize(cbName);
                        var found = false;
                        dojo.forEach(request._connects, function(connect){
                            if (connect[0] == request && connect[1] == cbMapping){ found = true }
                        });
                        t.t(found, "'" + cbName + "' callback was not connected");
                    }

                    var expectedMappedCallbacks = ["complete", "interactive", "loaded", "loading"];
                    dojo.forEach(expectedMappedCallbacks, assertCallbackConnection);

                    try{
                        new drd.Request("test_unsupported_callback_parse");
                        t.t(false, "Request decorator should not have been instantiated with an unsupported callback");
                    }catch(e){
                        t.is("'unsupported' is an unsupported callback", e.message);
                    }
                }
            },
            {
                name: "Request method parsing",
                runTest: function(t) {
                    t.is("get", (new drd.Request("test_method_default")).getMethod());
                    t.is("put", (new drd.Request("test_method_with_data_attribute")).getMethod());
                    t.is("post", (new drd.Request("test_method_with_method_attribute")).getMethod());
                    t.is("delete", (new drd.Request("test_method_with_data_and_method_attribute")).getMethod());
                }
            },
            {
                name: "Request argument parsing",
                runTest: function(t){
                    var request = new drd.Request("test_args_parse");
                    t.is("/some/url", request._args.url);
                    t.is("a=b&c=d", request._args.params);
                    t.is("true", request._args.eval);
                    t.is("true", request._args.sync);
                }
            },
            {
                name: "Request argument mapping",
                runTest: function(t) {
                    var request = new drd.Request("test_args_parse");
                    var mappedArgs = request._mapToDojo({ 'foo': 'bar' });

                    t.is("/some/url", mappedArgs.url);
                    t.is({ a: 'b', c: 'd' }, mappedArgs.content);
                    t.is(true, mappedArgs.evalScripts);
                    t.is(true, mappedArgs.sync);

                    t.is(request.onSuccess, mappedArgs.load);
                    t.is(request.onFailure, mappedArgs.error);
                    t.is(request.onComplete, mappedArgs.handle);

                    t.is("bar", mappedArgs.foo);
                }
            },
            {
                name: "Request callback execution",
                runTest: function(t) {
                    t.mock(null, "execSuccessCallback");
                    t.mock(null, "execFailureCallback");
                    t.mock(null, "execCompleteCallback");
                    t.mock(null, "execInteractiveCallback");
                    t.mock(null, "execLoadedCallback");
                    t.mock(null, "execLoadingCallback");

                    var request = new drd.Request("test_callback_execution");

                    request.onSuccess();
                    t.assertMock(execSuccessCallback);

                    request.onFailure();
                    t.assertMock(execFailureCallback);

                    request.onComplete();
                    t.assertMock(execCompleteCallback);

                    request.onInteractive();
                    t.assertMock(execInteractiveCallback);

                    request.onLoaded();
                    t.assertMock(execLoadedCallback);

                    request.onLoading();
                    t.assertMock(execLoadingCallback);
                }
            },
            {
                name: "exec",
                runTest: function(t){
                    var request = new drd.Request("test_callback_execution");
                    request.setMethod("get");
                    t.mock(dojo, "xhrGet", function(){});
                    request.exec("/someurl");
                    t.assertMock(dojo.xhrGet);

                    request.setMethod("post");
                    t.mock(dojo, "xhrPost", function(){});
                    request.exec("/someurl");
                    t.assertMock(dojo.xhrPost);

                    request.setMethod("delete");
                    t.mock(dojo, "xhrDelete", function(){});
                    request.exec("/someurl");
                    t.assertMock(dojo.xhrDelete);

                    request.setMethod("put");
                    t.mock(dojo, "xhrPut", function(){});
                    request.exec("/someurl");
                    t.assertMock(dojo.xhrPut);

                    request.setMethod("trace");
                    t.mock(dojo, "xhr", function(){});
                    request.exec("/someurl");
                    t.assertMock(dojo.xhr);
                    t.is("trace", dojo.xhr.__mockArgs[0]);
                }
            }
        ]);

        function loadCb(request) {}
        function errorCb(request) {}

        function execSuccessCallback() {}
        function execFailureCallback() {}
        function execCompleteCallback() {}
        function execInteractiveCallback() {}
        function execLoadedCallback() {}
        function execLoadingCallback() {}

        dojo.addOnLoad(function() {
            doh.run();
        });
	</script>
</head>
<body>

<!-- Callback parse tests -->
<script type="javascript/json" id="test_successful_callback_parse" data-js-type="request"
      data-success-code="loadCb"
      data-failure-code="errorCb"
      data-complete-code="function(request) {}"
      data-interactive-code="function(request) {}"
      data-loaded-code="function(request) {}"
      data-loading-code="function(request) {}">
</script>

<script type="javascript/json" data-js-type="request" id="test_unsupported_callback_parse"
        data-unsupported-code="function() {}"></script>

<!-- Method parse tests -->
<script type="javascript/json" data-js-type="request" id="test_method_default"></script>
<script type="javascript/json" data-js-type="request" id="test_method_with_data_attribute"
        data-method="put"></script>
<script type="javascript/json" data-js-type="request" id="test_method_with_method_attribute"
        method="post"></script>
<script type="javascript/json" data-js-type="request" id="test_method_with_data_and_method_attribute"
        method="put"
        data-method="delete"></script>

<!-- Argument parse tests -->
<script type="javascript/json" data-js-type="request" id="test_args_parse"
        data-url="/some/url"
        data-params="a=b&c=d"
        data-eval="true"
        data-sync="true">
</script>

<!-- Callback execution tests -->
<script type="javascript/json" id="test_callback_execution" data-js-type="request" method="post"
      data-success-code="execSuccessCallback"
      data-failure-code="execFailureCallback"
      data-complete-code="execCompleteCallback"
      data-interactive-code="execInteractiveCallback"
      data-loaded-code="execLoadedCallback"
      data-loading-code="execLoadingCallback">
</script>

</body>
</html>